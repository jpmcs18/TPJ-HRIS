@model WebTemplate.Models.Maintenance.Systems.Page.Index
@{
    var PageAccess = (Session["CredentialPages"] as DataAccessLayer.Security.CredentialPages).GetPage("Maintenance/Systems/Page");
}

<div class="wrapper wrapper-content">
    <div class="page-heading">
        <div class="col-lg-8">
            @Html.Partial("~/Views/Shared/_Breadcrumbs.cshtml", PageAccess)
        </div>
        <div class="col-lg-4">
            <div class="title-action">
                @if (PageAccess.Insert)
                {
                    <a class="btn btn-primary compose-mail" href="#" id="btnadd">Add Page</a>
                }
            </div>
        </div>
    </div>
    <div id="form_search" class="panel-body" style="margin-top: 80px;">
        @Html.Partial("~/Views/Maintenance/Systems/Page/_Search.cshtml")
    </div>
</div>

<div class="modal inmodal custom-modal" id="modal_management" data-backdrop="static" data-keyboard="false" tabindex="" role="dialog" aria-hidden="true">
    <div class="vertical-alignment-helper">
        <div class="modal-center vertical-align-center">
            <div class="modal-content animated fadeInDown modal-width-80">
                <div id="formpost"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        event_search();
    });

    function manage(id) {
        $.ajax({
            url: '@Url.Action("Management", "Maintenance/Systems/Page")',
            data: { uid : id },
            type: "GET",
            cache: false,
            beforeSend: function () {
                ShowLoadingScreen()
            },
            complete: function () {
                RemoveLoadingScreen()
            },
            success: function (response) {
                $("#formpost").html(response);
                $('#modal_management').appendTo("body").modal('show');
                event_save();
            },
            error: function () {
                toastr.error('AJAX backend error', 'An error has occured.');
            }
        });
    }

    function event_save() {
        Select2Override();

        $(".touchspin").TouchSpin({
            verticalbuttons: true,
            buttondown_class: 'btn btn-white',
            buttonup_class: 'btn btn-white'
        });

        $('#btnsave').click(function () {
            var params = $('#formpost *').serializeArray();

            $.ajax({
                url: '@Url.Action("Save", "Maintenance/Systems/Page")',
                data: params,
                type: "POST",
                cache: false,
                beforeSend: function () {
                    ShowLoadingScreen()
                },
                complete: function () {
                    RemoveLoadingScreen()
                },
                success: function (response) {
                    if (response != null) {
                        if (response.success == true) {
                            toastr.success('Record Saved.');
                            manage(response.id)
                        }
                        else if (response.success == false) {
                            toastr.error(response.msg, 'An error has occured.');
                        }
                    }
                },
                error: function () {
                    toastr.error('AJAX backend error', 'An error has occured.');
                }
            })
        });
    }

    function event_search() {
        $('.footable').footable();
        Select2Override();
        //$('#Filter').focus();

        $('.pages').click(function () {
            $('#form_search_params input[name="PageNumber"]').val($(this).val());
            search();
        });

        $('#Filter').keydown(function () {
            if (event.keyCode == 13) {
                $('#btn_search').click()
            }
        });

        $('#btn_search').click(function () {
            $('#form_search_params input[name="PageNumber"]').val($(this).val());
            search()
        });

        $('#btnadd').click(function () {
            manage();
        });

        @if (ViewBag.uid != null && ViewBag.uid > 0)
        {
            @:manage('@ViewBag.uid');
        }

        $('.btnsearch').click(function () {
            manage($(this).val());
        });

        $('.btndelete').click(function () {
            var e = this
            swal({
                title: "Do you want to delete \"" + $(e).closest('tr').find('td:eq(0)').text() + "\" ?",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-danger",
                confirmButtonText: "Yes",
                cancelButtonText: "No",
                closeOnConfirm: false,
                closeOnCancel: false
            },
                function (isconfirm) {
                    if (isconfirm) {
                        var data = [{ name: '__RequestVerificationToken', value: $('#form_search_params input[name="__RequestVerificationToken"]').val() },
                        { name: 'uid', value: $(e).val() }]
                        $.ajax({
                            url: '@Url.Action("Delete", "Maintenance/Systems/Page")',
                            data: data,
                            cache: false,
                            type: "POST",
                            beforeSend: function () {
                                ShowLoadingScreen()
                            },
                            complete: function () {
                                RemoveLoadingScreen()
                            },
                            success: function (response) {
                                if (response != null) {
                                    if (response.success == true) {
                                        swal({
                                            title: "Success",
                                            text: "Delete Success.",
                                            type: "success",
                                        }, function () {
                                            search()
                                        });
                                    }
                                    else {
                                        swal("Failed", response.msg, "error");
                                    }
                                }
                            },
                            error: function (x, y, z) {
                                swal("Failed", "Something went wrong. Please try again.", "error");
                            }
                        })
                    }
                    else {
                        //swal("Cancelled", "Delete Cancelled", "success");
                    }
                }
            );
        });
    }

    function search() {
        var params = $('#form_search_params *').serializeArray();

        $.ajax({
            url: '@Url.Action("Index", "Maintenance/Systems/Page")',
            data: params,
            type: "GET",
            cache: false,
            beforeSend: function () {
                ShowLoadingScreen()
            },
            complete: function () {
                RemoveLoadingScreen()
            },
            success: function (response) {
                $("#form_search").html(response);
                event_search()
                $('#txt_search').focus()
            },
            error: function () {
                toastr.error('AJAX backend error', 'An error has occured.');
            }
        });
    }
</script>