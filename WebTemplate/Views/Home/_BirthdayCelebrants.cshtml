@model WebTemplate.Models.Personnel.Index
@using ProcessLayer.Processes;
@using ProcessLayer.Entities;

@*@{ 
    var BirthdayCelebrantsRecent = PersonnelProcess.GetBirthdayCelebrantsThisMonthRecent().ToList();
    var BirthdayCelebrantsToday = PersonnelProcess.GetBirthdayCelebrantsThisDay().ToList();
    var BirthdayCelebrantsUpcoming = PersonnelProcess.GetBirthdayCelebrantsThisMonthUpcoming().ToList();
}*@

@functions{
    public static Int32 GetAge(DateTime birthdate)
    {
        // Save today's date.
        var today = DateTime.Today;
        // Calculate the age.
        var age = today.Year - birthdate.Year;
        // Go back to the year in which the person was born in case of a leap year
        if (birthdate.Date > today.AddYears(-age)) age--;
        return age;
    }

    string getTab(int tabNo, List<Personnel> licenseList, bool isActive = false)
    {
        string element = $"<div id='bday-tab-{tabNo}' class='tab-pane{(isActive ? " active" : "")} bday-tab'><div class='panel-body' style='padding: 0px; '><table class='table table-stripped table-bordered' style='margin-bottom: 0px;'><tbody>";

        if (licenseList.Count() > 0)
        {
            var counter = 0;
            var prevBdayDay = 0;
            //string lastMonth = "";
            foreach (var person in licenseList)
            {
                String fullname = String.Format("{0}, {1} {2}", person.LastName, person.FirstName, person.MiddleName);
                String searchName = String.Format("{0}{1}{2}", person.FirstName, person.MiddleName, person.LastName);
                DateTime DateOfBirth = new DateTime(DateTime.Now.Year, person.BirthDate.Value.Month, person.BirthDate.Value.Day);
                String birthday = $"<tr class='list-title' style='background-color: #ddd;'><td>{DateOfBirth.ToString("dddd, MMMM dd")}</td></tr>";
                //String month = person.BirthDate.Value.ToString("MMMM");
                int age = person.BirthDate.Value != null ? GetAge(person.BirthDate.Value) : 0;

                element += counter > 0 ? (prevBdayDay != person.BirthDate.Value.Day ? birthday : "") : birthday;

                // element += $"{(month != lastMonth ? $"<tr><td>{month}</td></tr>" : "")}";
                element += $"<tr title='{fullname}, {age}' onclick='";
                //element += "window.open(" + '"' + ""{Url.Action("Personnel", "Index", new { Filter = searchName })}', '_blank');";
                element += $"'><td style='text-align: left; padding: 5px; border: 1px solid #eee;'><a href='/HumanResource/Personnel/Index?Filter={searchName}' target='_blank'><div style='float: left; text-transform: uppercase;'>";
                element += $"<img src='{(String.IsNullOrEmpty(person.ImagePath) ? "\\Images\\default.jpg" : person.ImagePath)}' style='height: 35px; width: 35px; min-height: 35px; min-width: 35px; border: 3px solid #eaeaea; margin-right: 10px; border-radius: 50px;' />";
                element += $"</div><div style='white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'><b>{fullname}</b><br />{age}</div></a></td></tr>";

                prevBdayDay = person.BirthDate.Value.Day;
                //lastMonth = month;
                counter++;
            }
        }
        else
        {
            element += "<tr><td style='text-align: center;'>No records...</td></tr>";
        }

        element += "</tbody></table></div></div>";
        return element;
    }
}

@*<div class="ibox-title bg-primary">
        <a href="" target="_blank" style="color: #fff;" title="Go to Birthdays Celebrants">
            <h3 class="" style="text-align: center; margin: 0px -15px;"><i class="fa fa-birthday-cake" style="font-size: 20px;"></i>&nbsp;&nbsp;&nbsp;Birthday Celebrants</h3>
        </a>
    </div>*@
<div class="tabs-container bday-container">
    <ul class="nav nav-tabs bday-tabs">
        <li class="active"><a data-toggle="tab" href="#bday-tab-1">Today</a></li>
        <li class=""><a data-toggle="tab" href="#bday-tab-2">Recent</a></li>
        <li class=""><a data-toggle="tab" href="#bday-tab-3">Upcoming</a></li>
    </ul>
    <div class="tab-content bday-tab-content">
        @Html.Raw(getTab(1, Model.BirthdayCelebrantsToday, true))
        @Html.Raw(getTab(2, Model.BirthdayCelebrantsRecent))
        @Html.Raw(getTab(3, Model.BirthdayCelebrantsUpcoming))
    </div>
</div>